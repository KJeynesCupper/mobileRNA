#' Differential Expression (DE) Analysis of sRNA dicer-derived clusters
#' using `DESeq2` or `edgeR`
#'
#' @description This function allows you to compute the differential expression
#' of sRNA dicer-derived clusters. The function allows the choice between
#' analysis with `DESeq2` or `edgeR`.
#'
#' @param data data.frame; originally generated by [mobileRNA::RNAimport()].
#'
#' @param group character; vector contains the condition
#' (ie. treatment or control) of each sample in the order samples are shown in 
#' the `data` object from left to right.
#'
#' @param method character; method to undertaken differential analysis, choose 
#' from methods of either [DESeq2::DESeq] or [edgeR::edgeR].
#' Must be stated as either "DESeq2" or "edgeR" in the function.
#'
#' @param dispersionValue numeric; manual setting of dispersion value
#' which is recommended for analysis in experiments without biological
#' replicates when utilising the [edgeR::edgeR] method.
#'
#'
#' @return Undertakes differential analysis, based on a specified method, and
#' adds the results to the supplied dataframe. This includes:
#' * Count mean
#' * Log fold change
#' * p-value
#' * Adjusted p-value
#' * Log counts per million (CPM/RPM)
#'
#' @details The analysis allows the users to choose the method which best suits
#' their data. Notably, `DESeq2` cannot compute the analysis when there only
#' one replicate per condition, but, `edgeR` can. Simply set a suitable
#' dispersion value, based on similar data, to use this feature. The dispersion
#' value is other wise known as the common Biological squared coefficient
#' of variation. A typical dispersion value is 0.4 for human data sets, 0.1 for
#' data on genetically identical model organisms or 0.01 for technical
#' replicate. See the User’s Guide for the  ‘EdgeR’ package for more details,
#' [edgeR::edgeR].
#'
#' @examples
#'
#' data("sRNA_data_consensus")
#'# sample conditions.
#' groups <- c("Heterograft", "Heterograft", "Heterograft",
#'           "Selfgraft", "Selfgraft", "Selfgraft")
#'
#'
#'## Differential analysis: DEseq2 method
#'sRNA_DESeq2 <- RNAdifferentialAnalysis(data = sRNA_data_consensus,
#'                              group = groups,
#'                              method = "DESeq2" )
#'
#'
#'## Differential analysis: edgeR method
#'sRNA_edgeR <- RNAdifferentialAnalysis(data = sRNA_data_consensus,
#'                             group = groups,
#'                             method = "edgeR" )

#' @export
#' @importFrom DESeq2 "results"
#' @importFrom DESeq2 "DESeq"
#' @importFrom stats "relevel"
#' @importFrom edgeR "exactTest"
#' @importFrom stats "p.adjust"
#' @importFrom dplyr "select"
#' @importFrom tidyselect "starts_with"
#' @importFrom dplyr "mutate_at"
#' @importFrom tidyr "replace_na"

RNAdifferentialAnalysis <- function(data, group, method = c("edgeR", "DESeq2"),
                        dispersionValue = NULL){
  if (base::missing(data) || !base::inherits(data,  "data.frame")) {
    stop("Please specify a data frame")
  }
  if (base::missing(method) || !method %in% c("edgeR", "DESeq2")) {
    stop("Please specify analysis method", "(\"edgeR\", or \"DESeq2\")")
  }
  if ( is.null(group) || !base::inherits(group, "character")) {
    stop("group must be an vector of characters to specify the treatment
         and control conditions for each replicate")
  }
  counts <- data %>% dplyr::select(tidyselect::starts_with("Count"))
  method <- base::match.arg(method)
  if(method == "edgeR"){
    res <-  .edgeR_normalise(counts, group)
    if(is.null(dispersionValue)){
      mean <- rowMeans(res$counts)
      groupConditions <- unique(group)
      comp <- edgeR::exactTest(res, pair= groupConditions)
      comp <- base::cbind(comp$table, padj=stats::p.adjust(comp$table$PValue,
                                                           method="BH"))
      comp$CountMean <- mean
    } else {
      comp <- edgeR::exactTest(res, dispersion=dispersionValue^2)
      comp <- base::cbind(comp$table, padj=stats::p.adjust(comp$table$PValue,
                                                           method="BH"))
    }
    data$CountMean <- comp$CountMean
    data$log2FoldChange <- comp$logFC
    data$pvalue <- comp$PValue
    data$padjusted <- comp$padj
    data$logCPM <- comp$logCPM
  } else
    if (method == "DESeq2"){
      res <- .DESeq_normalise(counts, group)
      comp <- DESeq2::DESeq(res)
      comp <- DESeq2::results(comp)
      data$baseMean <- comp[,"baseMean"]
      data$log2FoldChange <- comp[,"log2FoldChange"]
      data$pvalue <- comp[,"pvalue"]
      data$padjusted <- comp[,"padj"]
    }
  res.df <- data %>%
    dplyr::mutate_at(c('log2FoldChange','padjusted', 'pvalue'),
                     ~tidyr::replace_na(.,0))
  return(res.df)
}
